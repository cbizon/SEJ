<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SEJ - Effort Allocations</title>
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            margin: 1rem;
            background: #f8f9fa;
        }
        h1 { margin-bottom: 0.5rem; }
        #editing-banner {
            display: none;
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 8px 14px;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        #toolbar { margin-bottom: 0.5rem; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        #col-picker { position: relative; display: inline-block; }
        #col-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #fff;
            border: 1px solid #ccc;
            padding: 8px 12px;
            z-index: 100;
            min-width: 180px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
        }
        #col-dropdown.open { display: block; }
        #col-dropdown label { display: block; cursor: pointer; padding: 3px 0; white-space: nowrap; }
        button { cursor: pointer; padding: 4px 10px; }
        #show-all-btn.active { background: #0d6efd; color: #fff; border-color: #0d6efd; }
        #select-mode-btn.active { background: #198754; color: #fff; border-color: #198754; }
        #edit-data-btn { background: #0d6efd; color: #fff; border: 1px solid #0d6efd; }
        #save-btn { background: #198754; color: #fff; border: 1px solid #198754; }
        #discard-btn { background: #dc3545; color: #fff; border: 1px solid #dc3545; }
        #fix-totals-btn { background: #fd7e14; color: #fff; border: 1px solid #fd7e14; }
        .cell-selected { outline: 2px solid #198754 !important; outline-offset: -2px; }
        #selection-toolbar {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 8px 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 200;
            gap: 8px;
            align-items: center;
        }
        #selection-toolbar input {
            width: 80px;
            padding: 4px 6px;
            -moz-appearance: textfield;
        }
        #selection-toolbar input::-webkit-inner-spin-button,
        #selection-toolbar input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #selection-toolbar .count { font-size: 0.9em; color: #666; }
        /* Add-row modal */
        #add-row-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 300;
            justify-content: center;
            align-items: center;
        }
        #add-row-overlay.open { display: flex; }
        #add-employee-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 300;
            justify-content: center;
            align-items: center;
        }
        #add-employee-overlay.open { display: flex; }
        #add-row-form {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            min-width: 320px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        #add-row-form label { display: block; margin-top: 10px; font-weight: 600; }
        #add-row-form input, #add-row-form select { width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; }
        #add-row-form .btn-row { margin-top: 14px; display: flex; gap: 8px; justify-content: flex-end; }
    </style>
</head>
<body>
    <h1>Effort Allocations</h1>
    <nav style="margin-bottom:0.5rem">
        <a href="/budget-lines" style="text-decoration:none;color:#0d6efd;font-size:0.9em">Budget Lines</a>
        <a href="/reports" style="text-decoration:none;color:#0d6efd;font-size:0.9em;margin-left:1rem">Reports</a>
    </nav>
    <div id="editing-banner"></div>
    <div id="toolbar">
        <div id="col-picker">
            <button id="col-btn">Columns &#9660;</button>
            <div id="col-dropdown"></div>
        </div>
        <button id="show-all-btn">Show all rows</button>
        <button id="view-toggle-btn">Show projects view</button>
        <button id="export-btn">Export TSV</button>
        <button id="edit-data-btn" style="display:none">Edit data</button>
        <button id="select-mode-btn" style="display:none">Selection mode</button>
        <button id="fix-totals-btn" style="display:none">Fix totals</button>
        <button id="add-employee-btn" style="display:none">Add employee</button>
        <button id="add-row-btn" style="display:none">Add allocation line</button>
        <button id="save-btn" style="display:none">Save changes</button>
        <button id="discard-btn" style="display:none">Discard changes</button>
    </div>
    <div id="table"></div>

    <div id="selection-toolbar">
        <span class="count"><span id="sel-count">0</span> cells selected</span>
        <input type="number" id="sel-value" placeholder="%" min="0" max="100" step="0.01">
        <button id="sel-apply">Apply</button>
        <button id="sel-clear">Clear</button>
    </div>

    <div id="add-row-overlay">
        <div id="add-row-form">
            <h3 style="margin-top:0">Add Allocation Line</h3>
            <label>Employee</label>
            <input id="ar-employee" list="ar-employee-list" placeholder="Type to search">
            <datalist id="ar-employee-list"></datalist>
            <label>Budget Line Code</label>
            <input id="ar-budget-line-code" list="ar-budget-line-list" placeholder="Type or select">
            <datalist id="ar-budget-line-list"></datalist>
            <div class="btn-row">
                <button id="ar-cancel">Cancel</button>
                <button id="ar-submit">Add</button>
            </div>
        </div>
    </div>

    <div id="add-employee-overlay">
        <div id="add-row-form">
            <h3 style="margin-top:0">Add Employee</h3>
            <label>First Name</label>
            <input id="ae-first-name" placeholder="First name">
            <label>Last Name</label>
            <input id="ae-last-name" placeholder="Last name">
            <label>Middle Name <span style="font-weight:normal;font-size:0.9em">(optional)</span></label>
            <input id="ae-middle-name" placeholder="Middle name">
            <label>Group</label>
            <select id="ae-group"></select>
            <label>Salary</label>
            <input id="ae-salary" type="number" min="0" step="1000" value="120000">
            <div class="btn-row">
                <button id="ae-cancel">Cancel</button>
                <button id="ae-submit">Add</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script>
        const monthPattern = /January|February|March|April|May|June|July|August|September|October|November|December/;
        const hiddenByDefault = new Set([
            "Fund Code", "Source", "Account",
            "Cost Code 1", "Cost Code 2", "Cost Code 3", "Program Code",
        ]);

        function monthSorter(a, b) {
            const parse = v => (v === "" || v == null) ? -Infinity : parseFloat(v);
            return parse(a) - parse(b);
        }

        function isPastMonth(name) {
            if (!monthPattern.test(name)) return false;
            const d = new Date(name + " 1");
            const now = new Date();
            return d.getFullYear() < now.getFullYear() ||
                   (d.getFullYear() === now.getFullYear() && d.getMonth() < now.getMonth());
        }

        function parseMonthLabel(label) {
            const d = new Date(label + " 1");
            return { year: d.getFullYear(), month: d.getMonth() + 1 };
        }

        let showAllRows = false;
        let selectMode = false;
        let selectedCells = new Set(); // Set of "lineId|field" strings
        let selectedElements = new Map(); // "lineId|field" -> DOM element
        let isDragging = false;
        let projectsView = false; // Toggle between lines view and projects view
        let originalData = []; // Store original data for toggling back

        function applyRowFilter(table) {
            if (showAllRows) {
                table.clearFilter();
                return;
            }
            const visibleMonthFields = table.getColumns()
                .filter(c => c.isVisible() && monthPattern.test(c.getField()))
                .map(c => c.getField());
            if (visibleMonthFields.length === 0) {
                table.clearFilter();
                return;
            }
            table.setFilter(row => visibleMonthFields.some(f => row[f] !== "" && row[f] != null));
        }

        function computeViolations(data, monthFields, externalGroups) {
            const violations = new Set();
            const sums = {};
            data.forEach(row => {
                if (externalGroups && externalGroups.has(row["Group"])) return;
                const emp = row["Employee"];
                if (!sums[emp]) sums[emp] = {};
                monthFields.forEach(mf => {
                    const val = row[mf];
                    const pct = (val !== "" && val != null) ? parseFloat(val) : 0;
                    sums[emp][mf] = (sums[emp][mf] || 0) + (isNaN(pct) ? 0 : pct);
                });
            });
            Object.entries(sums).forEach(([emp, monthSums]) => {
                monthFields.forEach(mf => {
                    if (Math.abs((monthSums[mf] || 0) - 100) > 0.01) {
                        violations.add(`${emp}|${mf}`);
                    }
                });
            });
            return violations;
        }

        function updateSelectionToolbar() {
            const tb = document.getElementById("selection-toolbar");
            document.getElementById("sel-count").textContent = selectedCells.size;
            tb.style.display = selectedCells.size > 0 ? "flex" : "none";
        }

        function clearSelection() {
            selectedElements.forEach(el => el.classList.remove("cell-selected"));
            selectedCells.clear();
            selectedElements.clear();
            updateSelectionToolbar();
        }

        function rollUpToProjects(data, monthFields) {
            // Group by Employee, Group, and Project, summing effort across budget lines
            const grouped = {};
            data.forEach(row => {
                const project = row["Project"] || "(No Project)";
                const key = `${row["Employee"]}|${row["Group"]}|${project}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        "Employee": row["Employee"],
                        "Group": row["Group"],
                        "Project": project,
                    };
                    // Initialize month fields
                    monthFields.forEach(mf => {
                        grouped[key][mf] = 0;
                    });
                }
                // Sum the effort percentages
                monthFields.forEach(mf => {
                    const val = row[mf];
                    if (val !== "" && val != null) {
                        const pct = parseFloat(String(val).replace("%", ""));
                        if (!isNaN(pct)) {
                            grouped[key][mf] += pct;
                        }
                    }
                });
            });

            // Convert back to array and format percentages
            return Object.values(grouped).map(row => {
                monthFields.forEach(mf => {
                    const val = row[mf];
                    row[mf] = val > 0 ? `${val.toFixed(2)}%` : "";
                });
                return row;
            });
        }

        Promise.all([
            fetch("/api/data").then(r => r.json()),
            fetch("/api/groups").then(r => r.json()),
        ]).then(([{columns, data, editable, change_set_name}, groupsList]) => {
                originalData = data; // Store for toggling
                const externalGroups = new Set(
                    groupsList.filter(g => !g.is_internal).map(g => g.name)
                );
                // Show editing banner and edit-mode buttons
                if (editable && change_set_name) {
                    const banner = document.getElementById("editing-banner");
                    banner.textContent = `Editing session: ${change_set_name}`;
                    banner.style.display = "block";
                    document.getElementById("select-mode-btn").style.display = "";
                    document.getElementById("fix-totals-btn").style.display = "";
                    document.getElementById("add-employee-btn").style.display = "";
                    document.getElementById("add-row-btn").style.display = "";
                    document.getElementById("save-btn").style.display = "";
                    document.getElementById("discard-btn").style.display = "";
                } else {
                    document.getElementById("edit-data-btn").style.display = "";
                }

                const monthFields = columns.filter(name => monthPattern.test(name));
                let violations = computeViolations(data, monthFields, externalGroups);

                const colDefs = columns.map(name => {
                    const isMonth = monthPattern.test(name);
                    const def = {
                        title: name,
                        field: name,
                        headerFilter: "input",
                        sorter: isMonth ? monthSorter : "string",
                        visible: name !== "allocation_line_id" && !hiddenByDefault.has(name) && !isPastMonth(name),
                    };
                    if (isMonth) {
                        if (editable) {
                            def.editor = "input";
                        }
                        def.formatter = (cell) => {
                            const rowData = cell.getRow().getData();
                            const emp = rowData["Employee"];
                            const lineId = rowData["allocation_line_id"];
                            const key = `${lineId}|${name}`;
                            const el = cell.getElement();
                            if (violations.has(`${emp}|${name}`)) {
                                el.style.backgroundColor = "#ffcccc";
                            } else {
                                el.style.backgroundColor = "";
                            }
                            if (selectedCells.has(key)) {
                                el.classList.add("cell-selected");
                                selectedElements.set(key, el);
                            } else {
                                el.classList.remove("cell-selected");
                            }
                            return cell.getValue() ?? "";
                        };
                        if (editable) {
                            def.cellMouseDown = (e, cell) => {
                                if (!selectMode) return;
                                e.preventDefault();
                                isDragging = true;
                                const rowData = cell.getRow().getData();
                                const lineId = rowData["allocation_line_id"];
                                const field = cell.getField();
                                const key = `${lineId}|${field}`;
                                const el = cell.getElement();
                                if (selectedCells.has(key)) {
                                    selectedCells.delete(key);
                                    selectedElements.delete(key);
                                    el.classList.remove("cell-selected");
                                } else {
                                    selectedCells.add(key);
                                    selectedElements.set(key, el);
                                    el.classList.add("cell-selected");
                                }
                                updateSelectionToolbar();
                            };
                            def.cellMouseOver = (e, cell) => {
                                if (!selectMode || !isDragging) return;
                                const rowData = cell.getRow().getData();
                                const lineId = rowData["allocation_line_id"];
                                const field = cell.getField();
                                const key = `${lineId}|${field}`;
                                const el = cell.getElement();
                                if (!selectedCells.has(key)) {
                                    selectedCells.add(key);
                                    selectedElements.set(key, el);
                                    el.classList.add("cell-selected");
                                    updateSelectionToolbar();
                                }
                            };
                        }
                    }
                    return def;
                });

                const table = new Tabulator("#table", {
                    data: data,
                    columns: colDefs,
                    layout: "fitDataFill",
                    height: "85vh",
                    renderMode: "basic",
                    initialSort: [
                        {column: "Group", dir: "asc"},
                        {column: "Employee", dir: "asc"},
                    ],
                });

                document.addEventListener("mouseup", () => { isDragging = false; });

                function applyGroupBorders() {
                    const sorters = table.getSorters();
                    if (sorters.length === 0) return;
                    const fields = sorters.map(s => s.field);
                    const rows = table.getRows("active");
                    rows.forEach((row, i) => {
                        const el = row.getElement();
                        if (!el) return;
                        const hasBorder = i > 0 && fields.some(f =>
                            row.getData()[f] !== rows[i - 1].getData()[f]
                        );
                        el.style.borderTop = hasBorder ? "2px solid #888" : "";
                    });
                }

                function scheduleBorders() {
                    setTimeout(applyGroupBorders, 0);
                }

                table.on("renderComplete", scheduleBorders);
                table.on("dataFiltered", scheduleBorders);
                table.on("dataSorted", scheduleBorders);

                table.on("cellEditing", (cell) => {
                    if (selectMode || projectsView) cell.cancelEdit();
                });

                const btn = document.getElementById("col-btn");
                const dropdown = document.getElementById("col-dropdown");
                const showAllBtn = document.getElementById("show-all-btn");
                const selectModeBtn = document.getElementById("select-mode-btn");

                table.on("tableBuilt", () => {
                    applyRowFilter(table);

                    table.getColumns().forEach(col => {
                        const field = col.getField();
                        if (field === "allocation_line_id") return;
                        const label = document.createElement("label");
                        const cb = document.createElement("input");
                        cb.type = "checkbox";
                        cb.checked = col.isVisible();
                        cb.addEventListener("change", () => col.toggle());
                        label.appendChild(cb);
                        label.appendChild(document.createTextNode("\u00a0" + col.getDefinition().title));
                        dropdown.appendChild(label);
                    });
                });

                table.on("columnVisibilityChanged", () => applyRowFilter(table));

                // Cell edit handler â€” persist to server
                if (editable) {
                    table.on("cellEdited", (cell) => {
                        const field = cell.getField();
                        if (!monthPattern.test(field)) return;

                        const rowData = cell.getRow().getData();
                        const lineId = rowData["allocation_line_id"];
                        const {year, month} = parseMonthLabel(field);
                        const raw = cell.getValue();
                        let pct = null;
                        if (raw !== "" && raw != null) {
                            pct = parseFloat(String(raw).replace("%", ""));
                            if (isNaN(pct)) pct = null;
                        }

                        fetch("/api/effort", {
                            method: "PUT",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({
                                allocation_line_id: lineId,
                                year: year,
                                month: month,
                                percentage: pct,
                            }),
                        }).then(r => {
                            if (!r.ok) r.json().then(d => alert("Error: " + d.error));
                        });

                        // Update the cell display value
                        if (pct !== null) {
                            cell.setValue(pct.toFixed(2) + "%", true);
                        } else {
                            cell.setValue("", true);
                        }

                        // Recompute violations
                        const allData = table.getData();
                        violations = computeViolations(allData, monthFields, externalGroups);
                        table.getRows().forEach(row => {
                            monthFields.forEach(mf => {
                                const c = row.getCell(mf);
                                if (c) c.getElement().style.backgroundColor = "";
                            });
                        });
                        table.getRows().forEach(row => {
                            const emp = row.getData()["Employee"];
                            monthFields.forEach(mf => {
                                if (violations.has(`${emp}|${mf}`)) {
                                    const c = row.getCell(mf);
                                    if (c) c.getElement().style.backgroundColor = "#ffcccc";
                                }
                            });
                        });
                    });
                }

                showAllBtn.addEventListener("click", () => {
                    showAllRows = !showAllRows;
                    showAllBtn.classList.toggle("active", showAllRows);
                    applyRowFilter(table);
                });

                document.getElementById("view-toggle-btn").addEventListener("click", () => {
                    projectsView = !projectsView;
                    const btn = document.getElementById("view-toggle-btn");

                    // If in selection mode, turn it off
                    if (selectMode) {
                        selectMode = false;
                        selectModeBtn.classList.remove("active");
                        clearSelection();
                    }

                    if (projectsView) {
                        btn.textContent = "Show lines view";
                        // Roll up data by projects
                        const rolledUpData = rollUpToProjects(originalData, monthFields);
                        table.replaceData(rolledUpData);

                        // Hide budget line columns
                        const columnsToHide = [
                            "Budget Line Code", "Budget Line Name",
                            "Fund Code", "Source", "Account",
                            "Cost Code 1", "Cost Code 2", "Cost Code 3", "Program Code"
                        ];
                        table.getColumns().forEach(col => {
                            if (columnsToHide.includes(col.getDefinition().title)) {
                                col.hide();
                            }
                        });

                        // Disable editing features in projects view
                        if (editable) {
                            selectModeBtn.disabled = true;
                            selectModeBtn.style.opacity = "0.5";
                        }
                    } else {
                        btn.textContent = "Show projects view";
                        // Restore original data
                        table.replaceData(originalData);

                        // Restore column visibility based on hiddenByDefault
                        const columnsToShow = [
                            "Budget Line Code", "Budget Line Name"
                        ];
                        table.getColumns().forEach(col => {
                            const title = col.getDefinition().title;
                            if (columnsToShow.includes(title)) {
                                col.show();
                            }
                            // Other columns stay hidden if they were in hiddenByDefault
                        });

                        // Re-enable editing features
                        if (editable) {
                            selectModeBtn.disabled = false;
                            selectModeBtn.style.opacity = "1";
                        }
                    }

                    // Recompute violations and reapply filters
                    violations = computeViolations(table.getData(), monthFields, externalGroups);
                    // Clear all backgrounds first
                    table.getRows().forEach(row => {
                        monthFields.forEach(mf => {
                            const c = row.getCell(mf);
                            if (c) c.getElement().style.backgroundColor = "";
                        });
                    });
                    // Reapply violation highlighting
                    table.getRows().forEach(row => {
                        const emp = row.getData()["Employee"];
                        monthFields.forEach(mf => {
                            if (violations.has(`${emp}|${mf}`)) {
                                const c = row.getCell(mf);
                                if (c) c.getElement().style.backgroundColor = "#ffcccc";
                            }
                        });
                    });
                    applyRowFilter(table);
                });

                document.getElementById("export-btn").addEventListener("click", () => {
                    const cols = table.getColumns().filter(c =>
                        c.isVisible() && c.getField() !== "allocation_line_id"
                    );
                    const headers = cols.map(c => c.getDefinition().title);
                    const rows = table.getRows("active");
                    const lines = [headers.join("\t")];
                    rows.forEach(row => {
                        const d = row.getData();
                        lines.push(cols.map(c => {
                            const v = d[c.getField()];
                            if (v == null) return "";
                            const s = String(v);
                            return monthPattern.test(c.getField()) ? s.replace("%", "") : s;
                        }).join("\t"));
                    });
                    const blob = new Blob([lines.join("\n")], {type: "text/tab-separated-values"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "effort_export.tsv";
                    a.click();
                    URL.revokeObjectURL(url);
                });

                // Fix totals
                document.getElementById("fix-totals-btn").addEventListener("click", () => {
                    fetch("/api/fix-totals", { method: "POST" })
                        .then(r => r.json())
                        .then(result => {
                            const n = result.changes ? result.changes.length : 0;
                            alert(`Fixed ${n} cell${n === 1 ? "" : "s"}.`);
                            return fetch("/api/data").then(r => r.json());
                        })
                        .then(({data}) => {
                            violations = computeViolations(data, monthFields, externalGroups);
                            table.replaceData(data);
                        });
                });

                // Selection mode
                selectModeBtn.addEventListener("click", () => {
                    selectMode = !selectMode;
                    selectModeBtn.classList.toggle("active", selectMode);
                    if (!selectMode) clearSelection();
                });

                // Selection apply
                document.getElementById("sel-apply").addEventListener("click", () => {
                    const val = document.getElementById("sel-value").value;
                    if (val === "") return;
                    const pct = parseFloat(val);
                    if (isNaN(pct) || pct < 0 || pct > 100) {
                        alert("Enter a valid percentage (0-100)");
                        return;
                    }
                    const formatted = pct.toFixed(2) + "%";
                    const promises = [];
                    selectedCells.forEach(key => {
                        const [lineId, field] = key.split("|");
                        const {year, month} = parseMonthLabel(field);
                        promises.push(
                            fetch("/api/effort", {
                                method: "PUT",
                                headers: {"Content-Type": "application/json"},
                                body: JSON.stringify({
                                    allocation_line_id: parseInt(lineId),
                                    year, month, percentage: pct,
                                }),
                            })
                        );
                    });

                    Promise.all(promises).then(() => {
                        // Update table data
                        selectedCells.forEach(key => {
                            const [lineId, field] = key.split("|");
                            table.getRows().forEach(row => {
                                if (String(row.getData()["allocation_line_id"]) === lineId) {
                                    row.getCell(field).setValue(formatted, true);
                                }
                            });
                        });
                        clearSelection();

                        // Recompute violations
                        const allData = table.getData();
                        violations = computeViolations(allData, monthFields, externalGroups);
                        table.getRows().forEach(row => {
                            const emp = row.getData()["Employee"];
                            monthFields.forEach(mf => {
                                const c = row.getCell(mf);
                                if (!c) return;
                                c.getElement().style.backgroundColor =
                                    violations.has(`${emp}|${mf}`) ? "#ffcccc" : "";
                            });
                        });
                    });
                });

                document.getElementById("sel-value").addEventListener("keydown", (e) => {
                    if (e.key === "Enter") document.getElementById("sel-apply").click();
                });

                document.getElementById("sel-clear").addEventListener("click", clearSelection);

                // Add employee
                document.getElementById("add-employee-btn").addEventListener("click", () => {
                    document.getElementById("ae-first-name").value = "";
                    document.getElementById("ae-last-name").value = "";
                    document.getElementById("ae-middle-name").value = "";
                    document.getElementById("ae-salary").value = "120000";

                    fetch("/api/groups").then(r => r.json()).then(groups => {
                        const sel = document.getElementById("ae-group");
                        sel.innerHTML = "";
                        groups.forEach(g => {
                            const opt = document.createElement("option");
                            opt.value = g.name;
                            opt.textContent = g.name;
                            sel.appendChild(opt);
                        });
                    });

                    document.getElementById("add-employee-overlay").classList.add("open");
                });

                document.getElementById("ae-cancel").addEventListener("click", () => {
                    document.getElementById("add-employee-overlay").classList.remove("open");
                });

                document.getElementById("ae-submit").addEventListener("click", () => {
                    const firstName = document.getElementById("ae-first-name").value.trim();
                    const lastName = document.getElementById("ae-last-name").value.trim();
                    const middleName = document.getElementById("ae-middle-name").value.trim();
                    const groupName = document.getElementById("ae-group").value;
                    const salary = parseFloat(document.getElementById("ae-salary").value);
                    if (!firstName || !lastName) {
                        alert("First name and last name are required.");
                        return;
                    }
                    fetch("/api/employee", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({
                            first_name: firstName,
                            last_name: lastName,
                            middle_name: middleName,
                            group_name: groupName,
                            salary: isNaN(salary) ? 120000 : salary,
                        }),
                    })
                    .then(r => {
                        if (!r.ok) return r.json().then(d => { alert("Error: " + d.error); throw new Error(); });
                        return r.json();
                    })
                    .then(() => {
                        document.getElementById("add-employee-overlay").classList.remove("open");
                    });
                });

                // Add row
                document.getElementById("add-row-btn").addEventListener("click", () => {
                    const overlay = document.getElementById("add-row-overlay");
                    overlay.classList.add("open");

                    // Load employees
                    fetch("/api/employees").then(r => r.json()).then(employees => {
                        const dl = document.getElementById("ar-employee-list");
                        dl.innerHTML = "";
                        employees.forEach(e => {
                            const opt = document.createElement("option");
                            opt.value = e.name;
                            opt.textContent = `${e.name} (${e.group})`;
                            dl.appendChild(opt);
                        });
                    });

                    // Load budget lines for autocomplete
                    fetch("/api/budget-lines").then(r => r.json()).then(budgetLines => {
                        const dl = document.getElementById("ar-budget-line-list");
                        dl.innerHTML = "";
                        budgetLines.forEach(bl => {
                            const opt = document.createElement("option");
                            opt.value = bl.budget_line_code;
                            opt.textContent = bl.name ? `${bl.budget_line_code} - ${bl.name}` : bl.budget_line_code;
                            dl.appendChild(opt);
                        });
                    });
                });

                document.getElementById("ar-cancel").addEventListener("click", () => {
                    document.getElementById("add-row-overlay").classList.remove("open");
                });

                document.getElementById("ar-submit").addEventListener("click", () => {
                    const employee = document.getElementById("ar-employee").value;
                    const code = document.getElementById("ar-budget-line-code").value.trim();
                    if (!employee || !code) {
                        alert("Employee and budget line code are required.");
                        return;
                    }
                    fetch("/api/allocation_line", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({
                            employee_name: employee,
                            budget_line_code: code,
                        }),
                    })
                    .then(r => {
                        if (!r.ok) return r.json().then(d => { alert("Error: " + d.error); throw new Error(); });
                        return r.json();
                    })
                    .then(result => {
                        const newLineId = result.allocation_line_id;
                        document.getElementById("add-row-overlay").classList.remove("open");
                        return fetch("/api/data").then(r => r.json()).then(d => ({data: d.data, newLineId}));
                    })
                    .then(({data, newLineId}) => {
                        // Switch to show-all-rows so the new row is visible
                        if (!showAllRows) {
                            showAllRows = true;
                            showAllBtn.classList.add("active");
                        }
                        table.replaceData(data).then(() => {
                            applyRowFilter(table);
                            violations = computeViolations(table.getData(), monthFields, externalGroups);
                            // Scroll to the new row
                            const rows = table.getRows();
                            for (const row of rows) {
                                if (row.getData()["allocation_line_id"] === newLineId) {
                                    table.scrollToRow(row, "center", false);
                                    row.getElement().style.transition = "background-color 0.5s";
                                    row.getElement().style.backgroundColor = "#d4edda";
                                    setTimeout(() => { row.getElement().style.backgroundColor = ""; }, 2000);
                                    break;
                                }
                            }
                        });
                    });
                });

                btn.addEventListener("click", e => {
                    e.stopPropagation();
                    dropdown.classList.toggle("open");
                });

                dropdown.addEventListener("click", e => e.stopPropagation());
                document.addEventListener("click", () => dropdown.classList.remove("open"));

                // Edit / Save / Discard handlers
                document.getElementById("edit-data-btn").addEventListener("click", () => {
                    fetch("/api/change-set/create", { method: "POST" })
                        .then(r => {
                            if (!r.ok) return r.json().then(d => { alert("Error: " + d.error); throw new Error(); });
                            return r.json();
                        })
                        .then(() => location.reload());
                });

                document.getElementById("save-btn").addEventListener("click", () => {
                    fetch("/api/change-set/merge", { method: "POST" })
                        .then(r => {
                            if (!r.ok) return r.json().then(d => { alert("Error: " + d.error); throw new Error(); });
                            return r.json();
                        })
                        .then(() => location.reload());
                });

                document.getElementById("discard-btn").addEventListener("click", () => {
                    if (!confirm("Discard all changes? This cannot be undone.")) return;
                    fetch("/api/change-set/discard", { method: "POST" })
                        .then(r => {
                            if (!r.ok) return r.json().then(d => { alert("Error: " + d.error); throw new Error(); });
                            return r.json();
                        })
                        .then(() => location.reload());
                });
            });
    </script>
</body>
</html>
