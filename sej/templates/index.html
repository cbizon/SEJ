<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SEJ - Effort Allocations</title>
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            margin: 1rem;
            background: #f8f9fa;
        }
        h1 { margin-bottom: 0.5rem; }
        #toolbar { margin-bottom: 0.5rem; display: flex; align-items: center; gap: 8px; }
        #col-picker { position: relative; display: inline-block; }
        #col-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #fff;
            border: 1px solid #ccc;
            padding: 8px 12px;
            z-index: 100;
            min-width: 180px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
        }
        #col-dropdown.open { display: block; }
        #col-dropdown label { display: block; cursor: pointer; padding: 3px 0; white-space: nowrap; }
        button { cursor: pointer; padding: 4px 10px; }
        #show-all-btn.active { background: #0d6efd; color: #fff; border-color: #0d6efd; }
    </style>
</head>
<body>
    <h1>Effort Allocations</h1>
    <div id="toolbar">
        <div id="col-picker">
            <button id="col-btn">Columns &#9660;</button>
            <div id="col-dropdown"></div>
        </div>
        <button id="show-all-btn">Show all rows</button>
    </div>
    <div id="table"></div>

    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script>
        const monthPattern = /January|February|March|April|May|June|July|August|September|October|November|December/;
        const hiddenByDefault = new Set([
            "Fund Code", "Source", "Account",
            "Cost Code 1", "Cost Code 2", "Cost Code 3", "Program Code",
        ]);

        function monthSorter(a, b) {
            const parse = v => (v === "" || v == null) ? -Infinity : parseFloat(v);
            return parse(a) - parse(b);
        }

        function isPastMonth(name) {
            if (!monthPattern.test(name)) return false;
            const d = new Date(name + " 1");
            const now = new Date();
            return d.getFullYear() < now.getFullYear() ||
                   (d.getFullYear() === now.getFullYear() && d.getMonth() < now.getMonth());
        }

        let showAllRows = false;

        function applyRowFilter(table) {
            if (showAllRows) {
                table.clearFilter(true);
                return;
            }
            const visibleMonthFields = table.getColumns()
                .filter(c => c.isVisible() && monthPattern.test(c.getField()))
                .map(c => c.getField());
            if (visibleMonthFields.length === 0) {
                table.clearFilter(true);
                return;
            }
            table.setFilter(row => visibleMonthFields.some(f => row[f] !== "" && row[f] != null));
        }

        fetch("/api/data")
            .then(r => r.json())
            .then(({columns, data}) => {
                // Compute per-employee per-month sums to find violations (should be 100).
                const monthFields = columns.filter(name => monthPattern.test(name));
                const violations = new Set();
                if (monthFields.length > 0) {
                    const sums = {};
                    data.forEach(row => {
                        const emp = row["Employee"];
                        if (!sums[emp]) sums[emp] = {};
                        monthFields.forEach(mf => {
                            const val = row[mf];
                            const pct = (val !== "" && val != null) ? parseFloat(val) : 0;
                            sums[emp][mf] = (sums[emp][mf] || 0) + (isNaN(pct) ? 0 : pct);
                        });
                    });
                    Object.entries(sums).forEach(([emp, monthSums]) => {
                        monthFields.forEach(mf => {
                            if (Math.abs((monthSums[mf] || 0) - 100) > 0.01) {
                                violations.add(`${emp}|${mf}`);
                            }
                        });
                    });
                }

                const colDefs = columns.map(name => {
                    const isMonth = monthPattern.test(name);
                    const def = {
                        title: name,
                        field: name,
                        headerFilter: "input",
                        sorter: isMonth ? monthSorter : "string",
                        visible: !hiddenByDefault.has(name) && !isPastMonth(name),
                    };
                    if (isMonth) {
                        def.formatter = (cell) => {
                            const emp = cell.getRow().getData()["Employee"];
                            if (violations.has(`${emp}|${name}`)) {
                                cell.getElement().style.backgroundColor = "#ffcccc";
                            }
                            return cell.getValue() ?? "";
                        };
                    }
                    return def;
                });

                const table = new Tabulator("#table", {
                    data: data,
                    columns: colDefs,
                    layout: "fitDataFill",
                    height: "85vh",
                    initialSort: [
                        {column: "Group", dir: "asc"},
                        {column: "Employee", dir: "asc"},
                    ],
                });

                const btn = document.getElementById("col-btn");
                const dropdown = document.getElementById("col-dropdown");
                const showAllBtn = document.getElementById("show-all-btn");

                table.on("tableBuilt", () => {
                    applyRowFilter(table);

                    table.getColumns().forEach(col => {
                        const label = document.createElement("label");
                        const cb = document.createElement("input");
                        cb.type = "checkbox";
                        cb.checked = col.isVisible();
                        cb.addEventListener("change", () => col.toggle());
                        label.appendChild(cb);
                        label.appendChild(document.createTextNode("\u00a0" + col.getDefinition().title));
                        dropdown.appendChild(label);
                    });
                });

                table.on("columnVisibilityChanged", () => applyRowFilter(table));

                showAllBtn.addEventListener("click", () => {
                    showAllRows = !showAllRows;
                    showAllBtn.classList.toggle("active", showAllRows);
                    applyRowFilter(table);
                });

                btn.addEventListener("click", e => {
                    e.stopPropagation();
                    dropdown.classList.toggle("open");
                });

                dropdown.addEventListener("click", e => e.stopPropagation());
                document.addEventListener("click", () => dropdown.classList.remove("open"));
            });
    </script>
</body>
</html>
