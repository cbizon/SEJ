<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SEJ - Project Details</title>
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: "Segoe UI", Arial, sans-serif; margin: 1rem; background: #f8f9fa; }
        h1 { margin-bottom: 0.25rem; }
        nav { margin-bottom: 0.5rem; }
        nav a { margin-right: 1rem; text-decoration: none; color: #0d6efd; }
        nav a:hover { text-decoration: underline; }
        .controls { margin-bottom: 1rem; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .controls label { font-weight: 600; }
        .controls select { padding: 4px 8px; font-size: 1em; }
        h2 { margin: 1.25rem 0 0.4rem; font-size: 1.05em; color: #343a40; }
        .toolbar { margin-bottom: 0.5rem; display: flex; align-items: center; gap: 8px; }
        .col-picker { position: relative; display: inline-block; }
        .col-dropdown {
            display: none; position: absolute; top: 100%; left: 0;
            background: #fff; border: 1px solid #ccc; padding: 8px 12px;
            z-index: 100; min-width: 180px; max-height: 400px; overflow-y: auto;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
        }
        .col-dropdown.open { display: block; }
        .col-dropdown label { display: block; cursor: pointer; padding: 3px 0; white-space: nowrap; }
        button { cursor: pointer; padding: 4px 10px; }
        #project-placeholder { color: #6c757d; font-style: italic; margin-top: 0.5rem; }
        #error { display: none; color: #dc3545; font-weight: 600; }
        #project-info {
            display: none;
            margin: 0.75rem 0 1rem;
            padding: 0.6rem 1rem;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        #project-info dl {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 0.2rem 1rem;
            margin: 0;
        }
        #project-info dt { font-weight: 600; color: #495057; }
        #project-info dd { margin: 0; }
        #people-table .tabulator-tableholder { padding-bottom: 17px; }
        #spending-section { display: none; margin-top: 1.5rem; }
        #spending-chart-wrap {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            max-width: 900px;
        }
        #history-section { display: none; margin-top: 1.5rem; }
        .history-group {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
        }
        .history-group-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
            font-size: 0.9em;
        }
        .history-group table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        .history-group th {
            text-align: left;
            padding: 3px 8px;
            border-bottom: 1px solid #dee2e6;
            color: #6c757d;
            font-weight: 600;
        }
        .history-group td {
            padding: 3px 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .history-group .arrow { color: #6c757d; }
    </style>
</head>
<body>
    <h1>Project Details</h1>
    <nav><a href="/reports">&larr; Reports</a></nav>

    <div class="controls">
        <label for="project-select">Project:</label>
        <select id="project-select">
            <option value="">Loading&hellip;</option>
        </select>
    </div>

    <div id="error"></div>
    <p id="project-placeholder">Select a project above.</p>

    <div id="project-info">
        <dl id="project-info-dl"></dl>
    </div>

    <div id="fte-section">
        <h2>Total FTE by Month</h2>
        <div class="toolbar">
            <div class="col-picker">
                <button id="fte-col-btn">Columns &#9660;</button>
                <div id="fte-col-dropdown" class="col-dropdown"></div>
            </div>
        </div>
        <div id="fte-table"></div>
    </div>

    <div id="people-section">
        <h2>Individual Effort by Month</h2>
        <div class="toolbar">
            <div class="col-picker">
                <button id="people-col-btn">Columns &#9660;</button>
                <div id="people-col-dropdown" class="col-dropdown"></div>
            </div>
        </div>
        <div id="people-table"></div>
    </div>

    <div id="spending-section">
        <h2>Remaining Personnel Budget</h2>
        <div id="spending-chart-wrap">
            <canvas id="spending-chart"></canvas>
        </div>
    </div>

    <div id="history-section">
        <h2>Change History</h2>
        <div id="history-content"></div>
    </div>

    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script>
        let fteTable = null;
        let peopleTable = null;
        let spendingChart = null;

        function fteFormatter(cell) {
            const v = cell.getValue();
            return (v != null && v !== "") ? v.toFixed(2) : "";
        }

        function pctFormatter(cell) {
            const v = cell.getValue();
            return (v != null && v !== "") ? v.toFixed(1) + "%" : "";
        }

        function fteColDef(m) {
            return {
                title: m, field: m,
                sorter: "number",
                hozAlign: "right",
                headerHozAlign: "right",
                formatter: fteFormatter,
            };
        }

        function pctColDef(m) {
            return {
                title: m, field: m,
                sorter: "number",
                hozAlign: "right",
                headerHozAlign: "right",
                formatter: pctFormatter,
            };
        }

        function setupColPicker(btnId, dropdownId, table) {
            const btn = document.getElementById(btnId);
            const dropdown = document.getElementById(dropdownId);
            dropdown.innerHTML = "";
            table.getColumns().forEach(col => {
                const lbl = document.createElement("label");
                const cb = document.createElement("input");
                cb.type = "checkbox";
                cb.checked = col.isVisible();
                cb.addEventListener("change", () => col.toggle());
                lbl.appendChild(cb);
                lbl.appendChild(document.createTextNode("\u00a0" + col.getDefinition().title));
                dropdown.appendChild(lbl);
            });
            btn.addEventListener("click", e => { e.stopPropagation(); dropdown.classList.toggle("open"); });
            dropdown.addEventListener("click", e => e.stopPropagation());
        }

        function showProjectInfo(info) {
            const panel = document.getElementById("project-info");
            const dl = document.getElementById("project-info-dl");
            dl.innerHTML = "";
            if (!info) { panel.style.display = "none"; return; }

            const fields = [
                ["Local PI",           info.local_pi_name],
                ["Admin Group",        info.admin_group_name],
                ["Start",              info.start],
                ["End",                info.end],
                ["Personnel Budget",   info.personnel_budget != null
                    ? "$" + info.personnel_budget.toLocaleString() : null],
            ];

            const populated = fields.filter(([, v]) => v != null);
            if (populated.length === 0) { panel.style.display = "none"; return; }

            populated.forEach(([label, value]) => {
                const dt = document.createElement("dt");
                dt.textContent = label;
                const dd = document.createElement("dd");
                dd.textContent = value;
                dl.appendChild(dt);
                dl.appendChild(dd);
            });
            panel.style.display = "block";
        }

        const MONTH_NAMES = [
            "", "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December",
        ];

        function showChangeHistory(groups) {
            const section = document.getElementById("history-section");
            const content = document.getElementById("history-content");
            content.innerHTML = "";
            if (!groups || groups.length === 0) {
                section.style.display = "none";
                return;
            }
            section.style.display = "block";
            groups.forEach(g => {
                const div = document.createElement("div");
                div.className = "history-group";
                const ts = new Date(g.timestamp).toLocaleString();
                const header = document.createElement("div");
                header.className = "history-group-header";
                header.textContent = ts + (g.branch_name ? " — " + g.branch_name : "");
                div.appendChild(header);

                const table = document.createElement("table");
                table.innerHTML = "<thead><tr><th>Type</th><th>Employee</th><th>Month</th><th>Old</th><th></th><th>New</th></tr></thead>";
                const tbody = document.createElement("tbody");
                g.changes.forEach(c => {
                    const tr = document.createElement("tr");
                    const monthLabel = c.month && c.year ? MONTH_NAMES[parseInt(c.month)] + " " + c.year : "";
                    const oldVal = c.old_value ? parseFloat(c.old_value).toFixed(2) + "%" : "";
                    const newVal = c.new_value ? parseFloat(c.new_value).toFixed(2) + "%" : "";
                    tr.innerHTML =
                        "<td>" + c.type + "</td>" +
                        "<td>" + c.employee + "</td>" +
                        "<td>" + monthLabel + "</td>" +
                        "<td>" + oldVal + "</td>" +
                        '<td class="arrow">&rarr;</td>' +
                        "<td>" + newVal + "</td>";
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                div.appendChild(table);
                content.appendChild(div);
            });
        }

        function showSpendingChart(data) {
            const section = document.getElementById("spending-section");
            if (!data || data.length === 0) {
                section.style.display = "none";
                return;
            }
            section.style.display = "block";

            const labels = data.map(d => d.month);
            const values = data.map(d => d.remaining);

            if (spendingChart) {
                spendingChart.data.labels = labels;
                spendingChart.data.datasets[0].data = values;
                spendingChart.update();
                return;
            }

            const ctx = document.getElementById("spending-chart").getContext("2d");
            spendingChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels,
                    datasets: [{
                        label: "Remaining Budget ($)",
                        data: values,
                        borderColor: "#0d6efd",
                        backgroundColor: "rgba(13,110,253,0.08)",
                        borderWidth: 2,
                        pointRadius: 3,
                        fill: true,
                        tension: 0,
                    }],
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => "$" + ctx.parsed.y.toLocaleString(undefined, {maximumFractionDigits: 0}),
                            },
                        },
                    },
                    scales: {
                        x: { ticks: { maxRotation: 45 } },
                        y: {
                            ticks: {
                                callback: v => "$" + v.toLocaleString(undefined, {maximumFractionDigits: 0}),
                            },
                        },
                    },
                },
            });
        }

        function initTables(months, fte_rows, people) {
            document.getElementById("project-placeholder").style.display = "none";

            const fteColDefs = [
                { title: "Label", field: "label", frozen: true },
                ...months.map(fteColDef),
            ];
            const peopleColDefs = [
                { title: "Name", field: "name", headerFilter: "input", frozen: true },
                { title: "Group", field: "group", headerFilter: "input" },
                ...months.map(pctColDef),
            ];

            fteTable = new Tabulator("#fte-table", {
                data: fte_rows,
                columns: fteColDefs,
                layout: "fitDataFill",
            });
            peopleTable = new Tabulator("#people-table", {
                data: people,
                columns: peopleColDefs,
                layout: "fitDataFill",
            });

            fteTable.on("tableBuilt", () => setupColPicker("fte-col-btn", "fte-col-dropdown", fteTable));
            peopleTable.on("tableBuilt", () => setupColPicker("people-col-btn", "people-col-dropdown", peopleTable));
        }

        function showError(msg) {
            const el = document.getElementById("error");
            el.textContent = "Error: " + msg;
            el.style.display = "";
        }

        function loadProject(project) {
            document.getElementById("error").style.display = "none";
            if (!project) { showProjectInfo(null); showSpendingChart(null); showChangeHistory(null); return; }

            fetch(`/api/project-details?project=${encodeURIComponent(project)}`)
                .then(r => {
                    if (!r.ok) return r.text().then(t => { throw new Error(`Server error ${r.status}: ${t}`); });
                    return r.json();
                })
                .then(({ months, fte_rows, people, project_info, spending_analysis }) => {
                    showProjectInfo(project_info);
                    showSpendingChart(spending_analysis);
                    if (fteTable === null) {
                        initTables(months, fte_rows, people);
                    } else {
                        fteTable.setData(fte_rows);
                        peopleTable.setData(people);
                    }
                })
                .catch(err => showError(err.message));

            fetch(`/api/project-change-history?project=${encodeURIComponent(project)}`)
                .then(r => r.ok ? r.json() : [])
                .then(groups => showChangeHistory(groups));
        }

        fetch("/api/projects")
            .then(r => r.json())
            .then(projects => {
                const sel = document.getElementById("project-select");
                sel.innerHTML = '<option value="">-- select a project --</option>';
                projects.forEach(p => {
                    const opt = document.createElement("option");
                    opt.value = p.project_code;
                    opt.textContent = p.project_code + (p.name ? " — " + p.name : "");
                    sel.appendChild(opt);
                });
                if (projects.length === 1) {
                    sel.value = projects[0].project_code;
                    loadProject(projects[0].project_code);
                }
            });

        document.getElementById("project-select").addEventListener("change", e => loadProject(e.target.value));

        document.addEventListener("click", () => {
            document.querySelectorAll(".col-dropdown").forEach(d => d.classList.remove("open"));
        });
    </script>
</body>
</html>
