<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SEJ - Project Details</title>
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: "Segoe UI", Arial, sans-serif; margin: 1rem; background: #f8f9fa; }
        h1 { margin-bottom: 0.25rem; }
        nav { margin-bottom: 0.5rem; }
        nav a { margin-right: 1rem; text-decoration: none; color: #0d6efd; }
        nav a:hover { text-decoration: underline; }
        .controls { margin-bottom: 1rem; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .controls label { font-weight: 600; }
        .controls input[type="text"] { padding: 4px 8px; font-size: 1em; }
        #project-picker { min-width: 360px; }
        h2 { margin: 1.25rem 0 0.4rem; font-size: 1.05em; color: #343a40; }
        h3 { margin: 1rem 0 0.3rem; font-size: 0.95em; color: #495057; }
        .toolbar { margin-bottom: 0.5rem; display: flex; align-items: center; gap: 8px; }
        .col-picker { position: relative; display: inline-block; }
        .col-dropdown {
            display: none; position: absolute; top: 100%; left: 0;
            background: #fff; border: 1px solid #ccc; padding: 8px 12px;
            z-index: 100; min-width: 180px; max-height: 400px; overflow-y: auto;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
        }
        .col-dropdown.open { display: block; }
        .col-dropdown label { display: block; cursor: pointer; padding: 3px 0; white-space: nowrap; }
        button { cursor: pointer; padding: 4px 10px; }
        #project-placeholder { color: #6c757d; font-style: italic; margin-top: 0.5rem; }
        #error { display: none; color: #dc3545; font-weight: 600; }
        #project-info {
            display: none;
            margin: 0.75rem 0 1rem;
            padding: 0.6rem 1rem;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        #project-info dl {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 0.2rem 1rem;
            margin: 0;
        }
        #project-info dt { font-weight: 600; color: #495057; }
        #project-info dd { margin: 0; }
        #project-info .budget-line-list {
            margin: 0;
            padding-left: 1.1rem;
        }
        #project-info .budget-line-list li {
            margin: 0.1rem 0;
        }
        #people-table .tabulator-tableholder { padding-bottom: 17px; }
        #spending-summary-section { display: none; margin-top: 1.25rem; }
        #spending-summary-table {
            width: 100%;
            max-width: 780px;
            border-collapse: collapse;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }
        #spending-summary-table th,
        #spending-summary-table td {
            padding: 6px 10px;
            border-bottom: 1px solid #f0f0f0;
            text-align: left;
            font-size: 0.92em;
        }
        #spending-summary-table th {
            background: #f5f7fa;
            color: #495057;
            font-weight: 600;
        }
        #spending-summary-table td:last-child {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        #spending-summary-table tr.budget-line-row td {
            background: #eef3fb;
        }
        #spending-section { display: none; margin-top: 1.5rem; }
        .spending-chart-wrap {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.6rem;
            max-width: 520px;
            height: 190px;
            margin-bottom: 0.7rem;
        }
        #bl-spending-section { display: none; margin-top: 1.5rem; }
        #history-section { display: none; margin-top: 1.5rem; }
        .history-group {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
        }
        .history-group-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
            font-size: 0.9em;
        }
        .history-group table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        .history-group th {
            text-align: left;
            padding: 3px 8px;
            border-bottom: 1px solid #dee2e6;
            color: #6c757d;
            font-weight: 600;
        }
        .history-group td {
            padding: 3px 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .history-group .arrow { color: #6c757d; }
        #fte-table .tabulator-data-tree-control,
        #people-table .tabulator-data-tree-control {
            display: none !important;
        }
        .tabulator-tree-level-1 {
            background-color: #eef3fb !important;
        }
        .tabulator-tree-level-1 .tabulator-cell {
            background-color: #eef3fb !important;
        }
    </style>
</head>
<body>
    <h1>Project Details</h1>
    <nav><a href="/reports">&larr; Reports</a></nav>

    <div class="controls">
        <label for="project-picker">Project:</label>
        <input id="project-picker" type="text" list="project-options" placeholder="Start typing project name...">
        <datalist id="project-options"></datalist>
    </div>

    <div id="error"></div>
    <p id="project-placeholder">Select a project above.</p>

    <div id="project-info">
        <dl id="project-info-dl"></dl>
    </div>

    <div id="fte-section">
        <h2>Total FTE by Month</h2>
        <div class="toolbar">
            <button id="fte-tree-btn">Expand budget lines</button>
            <div class="col-picker">
                <button id="fte-col-btn">Columns &#9660;</button>
                <div id="fte-col-dropdown" class="col-dropdown"></div>
            </div>
        </div>
        <div id="fte-table"></div>
    </div>

    <div id="people-section">
        <h2>Individual Effort by Month</h2>
        <div class="toolbar">
            <button id="people-tree-btn">Expand budget lines</button>
            <div class="col-picker">
                <button id="people-col-btn">Columns &#9660;</button>
                <div id="people-col-dropdown" class="col-dropdown"></div>
            </div>
        </div>
        <div id="people-table"></div>
    </div>

    <div id="spending-section">
        <div id="spending-summary-section">
            <h2>Projected Balances</h2>
            <table id="spending-summary-table">
                <thead>
                    <tr>
                        <th>Project/BudgetLine</th>
                        <th>End Date</th>
                        <th>Projected Balance</th>
                    </tr>
                </thead>
                <tbody id="spending-summary-body"></tbody>
            </table>
        </div>

        <h2>Remaining Personnel Budget</h2>
        <div class="spending-chart-wrap">
            <canvas id="spending-chart"></canvas>
        </div>
    </div>

    <div id="bl-spending-section">
        <h2>Per-Budget-Line Spending</h2>
        <div id="bl-spending-content"></div>
    </div>

    <div id="history-section">
        <h2>Change History</h2>
        <div id="history-content"></div>
    </div>

    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script>
        let fteTable = null;
        let peopleTable = null;
        let spendingChart = null;
        let blCharts = [];
        let allProjects = [];
        let fteTreeExpanded = false;
        let peopleTreeExpanded = false;
        let currentMonths = [];
        let currentFteRows = [];
        let currentPeopleRows = [];

        function fteFormatter(cell) {
            const v = cell.getValue();
            return (v != null && v !== "") ? v.toFixed(2) : "";
        }

        function pctFormatter(cell) {
            const v = cell.getValue();
            return (v != null && v !== "") ? v.toFixed(1) + "%" : "";
        }

        function fteColDef(m) {
            return {
                title: m, field: m,
                sorter: "number",
                hozAlign: "right",
                headerHozAlign: "right",
                formatter: fteFormatter,
            };
        }

        function pctColDef(m) {
            return {
                title: m, field: m,
                sorter: "number",
                hozAlign: "right",
                headerHozAlign: "right",
                formatter: pctFormatter,
            };
        }

        function setupColPicker(btnId, dropdownId, table) {
            const btn = document.getElementById(btnId);
            const dropdown = document.getElementById(dropdownId);
            dropdown.innerHTML = "";
            table.getColumns().forEach(col => {
                const lbl = document.createElement("label");
                const cb = document.createElement("input");
                cb.type = "checkbox";
                cb.checked = col.isVisible();
                cb.addEventListener("change", () => col.toggle());
                lbl.appendChild(cb);
                lbl.appendChild(document.createTextNode("\u00a0" + col.getDefinition().title));
                dropdown.appendChild(lbl);
            });
            btn.onclick = e => { e.stopPropagation(); dropdown.classList.toggle("open"); };
            dropdown.onclick = e => e.stopPropagation();
        }

        function showProjectInfo(info) {
            const panel = document.getElementById("project-info");
            const dl = document.getElementById("project-info-dl");
            dl.innerHTML = "";
            if (!info) { panel.style.display = "none"; return; }

            const fields = [
                ["Local PI",           info.local_pi_name],
                ["Admin Group",        info.admin_group_name],
                ["Start",              info.start],
                ["End",                info.end],
                ["Personnel Budget",   info.personnel_budget != null
                    ? "$" + info.personnel_budget.toLocaleString() : null],
            ];

            const populated = fields.filter(([, v]) => v != null);
            if (populated.length === 0) { panel.style.display = "none"; return; }

            populated.forEach(([label, value]) => {
                const dt = document.createElement("dt");
                dt.textContent = label;
                const dd = document.createElement("dd");
                dd.textContent = value;
                dl.appendChild(dt);
                dl.appendChild(dd);
            });

            const budgetLines = Array.isArray(info.budget_lines) ? info.budget_lines : [];
            if (budgetLines.length > 0) {
                const dt = document.createElement("dt");
                dt.textContent = budgetLines.length === 1 ? "Budget Line" : "Budget Lines";
                const dd = document.createElement("dd");
                const ul = document.createElement("ul");
                ul.className = "budget-line-list";

                budgetLines.forEach(bl => {
                    const li = document.createElement("li");
                    const name = bl.name || bl.code || "(unnamed)";
                    const code = bl.code ? ` (${bl.code})` : "";
                    const parts = [];
                    if (bl.start || bl.end) parts.push(`${bl.start || "?"} to ${bl.end || "?"}`);
                    if (bl.personnel_budget != null) parts.push("$" + bl.personnel_budget.toLocaleString());
                    const meta = parts.length > 0 ? ` — ${parts.join(" · ")}` : "";
                    li.textContent = `${name}${code}${meta}`;
                    ul.appendChild(li);
                });

                dd.appendChild(ul);
                dl.appendChild(dt);
                dl.appendChild(dd);
            }
            panel.style.display = "block";
        }

        const MONTH_NAMES = [
            "", "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December",
        ];

        function showChangeHistory(groups) {
            const section = document.getElementById("history-section");
            const content = document.getElementById("history-content");
            content.innerHTML = "";
            if (!groups || groups.length === 0) {
                section.style.display = "none";
                return;
            }
            section.style.display = "block";
            groups.forEach(g => {
                const div = document.createElement("div");
                div.className = "history-group";
                const ts = new Date(g.timestamp).toLocaleString();
                const header = document.createElement("div");
                header.className = "history-group-header";
                header.textContent = ts + (g.branch_name ? " — " + g.branch_name : "");
                div.appendChild(header);

                const table = document.createElement("table");
                table.innerHTML = "<thead><tr><th>Type</th><th>Employee</th><th>Month</th><th>Old</th><th></th><th>New</th></tr></thead>";
                const tbody = document.createElement("tbody");
                g.changes.forEach(c => {
                    const tr = document.createElement("tr");

                    let monthLabel = "";
                    if (c.month && c.year) {
                        const monthNum = Number.parseInt(c.month, 10);
                        if (Number.isFinite(monthNum) && monthNum >= 1 && monthNum <= 12) {
                            monthLabel = MONTH_NAMES[monthNum] + " " + c.year;
                        }
                    }

                    const oldNum = parseFloat(c.old_value);
                    const oldVal = (c.old_value !== null && c.old_value !== "" && Number.isFinite(oldNum)) ? oldNum.toFixed(2) + "%" : "";
                    const newNum = parseFloat(c.new_value);
                    const newVal = (c.new_value !== null && c.new_value !== "" && Number.isFinite(newNum)) ? newNum.toFixed(2) + "%" : "";

                    const typeTd = document.createElement("td");
                    typeTd.textContent = c.type || "";
                    const employeeTd = document.createElement("td");
                    employeeTd.textContent = c.employee || "";
                    const monthTd = document.createElement("td");
                    monthTd.textContent = monthLabel;
                    const oldTd = document.createElement("td");
                    oldTd.textContent = oldVal;
                    const arrowTd = document.createElement("td");
                    arrowTd.className = "arrow";
                    arrowTd.textContent = "\u2192";
                    const newTd = document.createElement("td");
                    newTd.textContent = newVal;
                    tr.append(typeTd, employeeTd, monthTd, oldTd, arrowTd, newTd);
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                div.appendChild(table);
                content.appendChild(div);
            });
        }

        function createSpendingChart(canvas, data) {
            const labels = data.map(d => d.month);
            const values = data.map(d => d.remaining);
            return new Chart(canvas.getContext("2d"), {
                type: "line",
                data: {
                    labels,
                    datasets: [{
                        label: "Remaining Budget ($)",
                        data: values,
                        borderColor: "#0d6efd",
                        backgroundColor: "rgba(13,110,253,0.08)",
                        borderWidth: 2,
                        pointRadius: 3,
                        fill: true,
                        tension: 0,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => "$" + ctx.parsed.y.toLocaleString(undefined, {maximumFractionDigits: 0}),
                            },
                        },
                    },
                    scales: {
                        x: { ticks: { maxRotation: 45 } },
                        y: {
                            ticks: {
                                callback: v => "$" + v.toLocaleString(undefined, {maximumFractionDigits: 0}),
                            },
                        },
                    },
                },
            });
        }

        function formatCurrency(value) {
            if (value == null || !Number.isFinite(value)) return "";
            return "$" + value.toLocaleString(undefined, {maximumFractionDigits: 2});
        }

        function projectedBalance(analysis) {
            if (!analysis || analysis.length === 0) return null;
            const last = analysis[analysis.length - 1];
            return Number.isFinite(last.remaining) ? last.remaining : null;
        }

        function showSpendingSummary(projectInfo, projectSpending, blSpending) {
            const section = document.getElementById("spending-summary-section");
            const body = document.getElementById("spending-summary-body");
            body.innerHTML = "";

            const rows = [];
            const projectRemaining = projectedBalance(projectSpending);
            if (projectInfo && projectRemaining != null) {
                rows.push({
                    name: projectInfo.name || "Project",
                    end: projectInfo.end || "",
                    remaining: projectRemaining,
                });
            }

            (blSpending || []).forEach(bl => {
                const remaining = projectedBalance(bl.spending_analysis);
                if (remaining == null) return;
                const name = bl.code ? `${bl.name} (${bl.code})` : bl.name;
                rows.push({
                    name,
                    end: bl.end || "",
                    remaining,
                    isBudgetLine: true,
                });
            });

            if (rows.length === 0) {
                section.style.display = "none";
                return;
            }

            rows.forEach(r => {
                const tr = document.createElement("tr");
                if (r.isBudgetLine) tr.className = "budget-line-row";
                const c1 = document.createElement("td");
                c1.textContent = r.name;
                const c2 = document.createElement("td");
                c2.textContent = r.end;
                const c3 = document.createElement("td");
                c3.textContent = formatCurrency(r.remaining);
                tr.append(c1, c2, c3);
                body.appendChild(tr);
            });
            section.style.display = "block";
        }

        function showSpendingChart(data) {
            const section = document.getElementById("spending-section");
            if (!data || data.length === 0) {
                section.style.display = "none";
                return;
            }
            section.style.display = "block";

            if (spendingChart) {
                spendingChart.data.labels = data.map(d => d.month);
                spendingChart.data.datasets[0].data = data.map(d => d.remaining);
                spendingChart.update();
                return;
            }

            spendingChart = createSpendingChart(document.getElementById("spending-chart"), data);
        }

        function showBudgetLineSpending(blSpending) {
            const section = document.getElementById("bl-spending-section");
            const content = document.getElementById("bl-spending-content");

            // Destroy old charts
            blCharts.forEach(c => c.destroy());
            blCharts = [];
            content.innerHTML = "";

            // Only show BLs that have spending analysis data
            const withData = (blSpending || []).filter(bl => bl.spending_analysis && bl.spending_analysis.length > 0);
            if (withData.length === 0) {
                section.style.display = "none";
                return;
            }
            section.style.display = "block";

            withData.forEach(bl => {
                const heading = document.createElement("h3");
                heading.textContent = bl.name;
                content.appendChild(heading);

                const wrap = document.createElement("div");
                wrap.className = "spending-chart-wrap";
                const canvas = document.createElement("canvas");
                wrap.appendChild(canvas);
                content.appendChild(wrap);

                blCharts.push(createSpendingChart(canvas, bl.spending_analysis));
            });
        }

        function buildFteTable(expanded) {
            const fteColDefs = [
                { title: "Label", field: "label", frozen: true },
                ...currentMonths.map(fteColDef),
            ];
            if (fteTable) fteTable.destroy();
            fteTable = new Tabulator("#fte-table", {
                data: currentFteRows,
                columns: fteColDefs,
                layout: "fitDataFill",
                dataTree: true,
                dataTreeStartExpanded: expanded,
            });
            fteTable.on("tableBuilt", () => setupColPicker("fte-col-btn", "fte-col-dropdown", fteTable));
        }

        function buildPeopleTable(expanded) {
            const peopleColDefs = [
                { title: "Name", field: "name", headerFilter: "input", frozen: true },
                { title: "Group", field: "group", headerFilter: "input" },
                ...currentMonths.map(pctColDef),
            ];
            if (peopleTable) peopleTable.destroy();
            peopleTable = new Tabulator("#people-table", {
                data: currentPeopleRows,
                columns: peopleColDefs,
                layout: "fitDataFill",
                dataTree: true,
                dataTreeStartExpanded: expanded,
            });
            peopleTable.on("tableBuilt", () => setupColPicker("people-col-btn", "people-col-dropdown", peopleTable));
        }

        function initTables(months, fte_rows, people) {
            document.getElementById("project-placeholder").style.display = "none";
            currentMonths = months;
            currentFteRows = fte_rows;
            currentPeopleRows = people;
            buildFteTable(false);
            buildPeopleTable(false);
            resetTreeButtons();
        }

        function setTreeExpanded(table, expand) {
            if (table === fteTable) buildFteTable(expand);
            if (table === peopleTable) buildPeopleTable(expand);
            return Promise.resolve();
        }

        function hasTreeRows(rows) {
            return rows.some(row => Array.isArray(row._children) && row._children.length > 0);
        }

        function resetTreeButtons() {
            fteTreeExpanded = false;
            peopleTreeExpanded = false;

            const fteBtn = document.getElementById("fte-tree-btn");
            const peopleBtn = document.getElementById("people-tree-btn");

            if (currentFteRows.length > 0) {
                const fteHasChildren = hasTreeRows(currentFteRows);
                fteBtn.textContent = "Expand budget lines";
                fteBtn.disabled = !fteHasChildren;
            }
            if (currentPeopleRows.length > 0) {
                const peopleHasChildren = hasTreeRows(currentPeopleRows);
                peopleBtn.textContent = "Expand budget lines";
                peopleBtn.disabled = !peopleHasChildren;
            }
        }

        function showError(msg) {
            const el = document.getElementById("error");
            el.textContent = "Error: " + msg;
            el.style.display = "";
        }

        function renderProjectOptions() {
            const list = document.getElementById("project-options");
            list.innerHTML = "";
            allProjects.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.name;
                list.appendChild(opt);
            });
        }

        function findProjectIdByInput(value) {
            if (!value) return "";
            const exact = allProjects.find(p => p.name === value);
            if (exact) return exact.id;
            const lower = value.trim().toLowerCase();
            if (!lower) return "";
            const partial = allProjects.filter(p => p.name.toLowerCase().includes(lower));
            if (partial.length === 1) return partial[0].id;
            return "";
        }

        function loadProject(projectId) {
            document.getElementById("error").style.display = "none";
            if (!projectId) {
                showProjectInfo(null);
                showSpendingChart(null);
                showBudgetLineSpending(null);
                showChangeHistory(null);
                return;
            }

            fetch(`/api/project-details?project_id=${encodeURIComponent(projectId)}`)
                .then(r => {
                    if (!r.ok) return r.text().then(t => { throw new Error(`Server error ${r.status}: ${t}`); });
                    return r.json();
                })
                .then(({ months, fte_rows, people, project_info, spending_analysis, budget_line_spending }) => {
                    showProjectInfo(project_info);
                    showSpendingSummary(project_info, spending_analysis, budget_line_spending);
                    showSpendingChart(spending_analysis);
                    showBudgetLineSpending(budget_line_spending);
                    if (fteTable === null) {
                        initTables(months, fte_rows, people);
                    } else {
                        currentMonths = months;
                        currentFteRows = fte_rows;
                        currentPeopleRows = people;
                        buildFteTable(false);
                        buildPeopleTable(false);
                        resetTreeButtons();
                    }
                })
                .catch(err => showError(err.message));

            fetch(`/api/project-change-history?project_id=${encodeURIComponent(projectId)}`)
                .then(r => {
                    if (!r.ok) return r.text().then(t => { throw new Error(`Server error ${r.status}: ${t}`); });
                    return r.json();
                })
                .then(groups => showChangeHistory(groups))
                .catch(err => showError(err.message));
        }

        fetch("/api/projects")
            .then(r => r.json())
            .then(projects => {
                allProjects = projects;
                renderProjectOptions();
                if (projects.length === 1) {
                    document.getElementById("project-picker").value = projects[0].name;
                    loadProject(projects[0].id);
                }
            });

        document.getElementById("project-picker").addEventListener("input", e => {
            const projectId = findProjectIdByInput(e.target.value);
            if (!projectId) return;
            loadProject(projectId);
        });

        document.getElementById("project-picker").addEventListener("keydown", e => {
            if (e.key !== "Enter") return;
            const projectId = findProjectIdByInput(e.target.value);
            if (!projectId) return;
            loadProject(projectId);
        });

        document.getElementById("fte-tree-btn").addEventListener("click", () => {
            if (!fteTable) return;
            fteTreeExpanded = !fteTreeExpanded;
            setTreeExpanded(fteTable, fteTreeExpanded).then(() => {
                document.getElementById("fte-tree-btn").textContent = fteTreeExpanded
                    ? "Collapse budget lines" : "Expand budget lines";
            });
        });

        document.getElementById("people-tree-btn").addEventListener("click", () => {
            if (!peopleTable) return;
            peopleTreeExpanded = !peopleTreeExpanded;
            setTreeExpanded(peopleTable, peopleTreeExpanded).then(() => {
                document.getElementById("people-tree-btn").textContent = peopleTreeExpanded
                    ? "Collapse budget lines" : "Expand budget lines";
            });
        });

        document.addEventListener("click", () => {
            document.querySelectorAll(".col-dropdown").forEach(d => d.classList.remove("open"));
        });
    </script>
</body>
</html>
