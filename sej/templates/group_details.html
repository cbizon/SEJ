<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SEJ - Group Details</title>
    <link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet">
    <style>
        body { font-family: "Segoe UI", Arial, sans-serif; margin: 1rem; background: #f8f9fa; }
        h1 { margin-bottom: 0.25rem; }
        nav { margin-bottom: 0.5rem; }
        nav a { margin-right: 1rem; text-decoration: none; color: #0d6efd; }
        nav a:hover { text-decoration: underline; }
        .controls { margin-bottom: 1rem; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .controls label { font-weight: 600; }
        .controls select { padding: 4px 8px; font-size: 1em; }
        h2 { margin: 1.25rem 0 0.4rem; font-size: 1.05em; color: #343a40; }
        .toolbar { margin-bottom: 0.5rem; display: flex; align-items: center; gap: 8px; }
        .col-picker { position: relative; display: inline-block; }
        .col-dropdown {
            display: none; position: absolute; top: 100%; left: 0;
            background: #fff; border: 1px solid #ccc; padding: 8px 12px;
            z-index: 100; min-width: 180px; max-height: 400px; overflow-y: auto;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
        }
        .col-dropdown.open { display: block; }
        .col-dropdown label { display: block; cursor: pointer; padding: 3px 0; white-space: nowrap; }
        button { cursor: pointer; padding: 4px 10px; }
        .placeholder { color: #6c757d; font-style: italic; }
        #people-section, #projects-section { display: none; }
        .tabulator-calcs-bottom .tabulator-cell {
            font-weight: bold !important;
            background-color: #e9ecef !important;
        }
        .tabulator-calcs-bottom { border-top: 2px solid #495057 !important; }
    </style>
</head>
<body>
    <h1>Group Details</h1>
    <nav><a href="/reports">&larr; Reports</a></nav>

    <div class="controls">
        <label for="group-select">Group:</label>
        <select id="group-select">
            <option value="">Loading&hellip;</option>
        </select>
    </div>

    <div id="error" style="display:none;color:#dc3545;font-weight:600"></div>

    <div id="people-section">
        <h2>Non-Project % by Person</h2>
        <div class="toolbar">
            <div class="col-picker">
                <button id="people-col-btn">Columns &#9660;</button>
                <div id="people-col-dropdown" class="col-dropdown"></div>
            </div>
        </div>
        <div id="people-table"></div>
    </div>

    <div id="projects-section">
        <h2>Total Effort by Project</h2>
        <div class="toolbar">
            <div class="col-picker">
                <button id="projects-col-btn">Columns &#9660;</button>
                <div id="projects-col-dropdown" class="col-dropdown"></div>
            </div>
        </div>
        <div id="projects-table"></div>
    </div>

    <script src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>
    <script>
        let peopleTable = null;
        let projectsTable = null;
        let currentTotals = {};

        function pctFormatter(cell) {
            const v = cell.getValue();
            return (v != null && v !== "") ? v.toFixed(1) + "%" : "";
        }

        function monthColDef(m) {
            return {
                title: m, field: m,
                headerFilter: "input",
                sorter: "number",
                hozAlign: "right",
                headerHozAlign: "right",
                formatter: pctFormatter,
            };
        }

        function setupColPicker(btnId, dropdownId, table) {
            const btn = document.getElementById(btnId);
            const dropdown = document.getElementById(dropdownId);
            dropdown.innerHTML = "";
            table.getColumns().forEach(col => {
                const lbl = document.createElement("label");
                const cb = document.createElement("input");
                cb.type = "checkbox";
                cb.checked = col.isVisible();
                cb.addEventListener("change", () => col.toggle());
                lbl.appendChild(cb);
                lbl.appendChild(document.createTextNode("\u00a0" + col.getDefinition().title));
                dropdown.appendChild(lbl);
            });
            btn.addEventListener("click", e => { e.stopPropagation(); dropdown.classList.toggle("open"); });
            dropdown.addEventListener("click", e => e.stopPropagation());
        }

        function initTables(months, people, projects) {
            document.getElementById("people-section").style.display = "";
            document.getElementById("projects-section").style.display = "";

            const totalRow = people.find(r => r.name === "Total");
            const peopleData = people.filter(r => r.name !== "Total");
            currentTotals = totalRow || {};

            const peopleColDefs = [
                {
                    title: "Name", field: "name", headerFilter: "input", frozen: true,
                    bottomCalc: () => "Total",
                },
                ...months.map(m => ({
                    ...monthColDef(m),
                    bottomCalc: () => currentTotals[m],
                    bottomCalcFormatter: pctFormatter,
                })),
            ];
            const projectColDefs = [
                { title: "Project", field: "project_code", headerFilter: "input" },
                { title: "Name", field: "project_name", headerFilter: "input" },
                ...months.map(monthColDef),
            ];

            peopleTable = new Tabulator("#people-table", {
                data: peopleData,
                columns: peopleColDefs,
                layout: "fitDataFill",
            });

            projectsTable = new Tabulator("#projects-table", {
                data: projects,
                columns: projectColDefs,
                layout: "fitDataFill",
            });

            peopleTable.on("tableBuilt", () => setupColPicker("people-col-btn", "people-col-dropdown", peopleTable));
            projectsTable.on("tableBuilt", () => setupColPicker("projects-col-btn", "projects-col-dropdown", projectsTable));
        }

        function showError(msg) {
            const el = document.getElementById("error");
            el.textContent = "Error: " + msg;
            el.style.display = "";
        }

        function loadGroup(group) {
            document.getElementById("error").style.display = "none";
            if (!group) return;

            fetch(`/api/group-details?group=${encodeURIComponent(group)}`)
                .then(r => {
                    if (!r.ok) return r.text().then(t => { throw new Error(`Server error ${r.status}: ${t}`); });
                    return r.json();
                })
                .then(({ months, people, projects }) => {
                    if (peopleTable === null) {
                        initTables(months, people, projects);
                    } else {
                        currentTotals = people.find(r => r.name === "Total") || {};
                        peopleTable.setData(people.filter(r => r.name !== "Total"));
                        peopleTable.recalc();
                        projectsTable.setData(projects);
                    }
                })
                .catch(err => showError(err.message));
        }

        // Load groups into dropdown
        fetch("/api/groups")
            .then(r => r.json())
            .then(groups => {
                const sel = document.getElementById("group-select");
                sel.innerHTML = '<option value="">-- select a group --</option>';
                groups.forEach(g => {
                    const opt = document.createElement("option");
                    opt.value = g;
                    opt.textContent = g;
                    sel.appendChild(opt);
                });
                if (groups.length === 1) {
                    sel.value = groups[0];
                    loadGroup(groups[0]);
                }
            });

        document.getElementById("group-select").addEventListener("change", e => loadGroup(e.target.value));

        document.addEventListener("click", () => {
            document.querySelectorAll(".col-dropdown").forEach(d => d.classList.remove("open"));
        });
    </script>
</body>
</html>
